<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName devin05.deploymirror.com
    ServerAdmin admin@deploymirror.com

    # Backend API - proxy to port 8001
    ProxyPreserveHost On
    ProxyPass /api/v1 http://localhost:8001/api/v1
    ProxyPassReverse /api/v1 http://localhost:8001/api/v1

    # Frontend - serve static files
    DocumentRoot /var/www/startup-health-check/frontend/dist
    
    <Directory /var/www/startup-health-check/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable rewrite for SPA routing
        RewriteEngine On
        RewriteBase /
        # Don't rewrite if file exists
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        # Don't rewrite API requests
        RewriteCond %{REQUEST_URI} !^/api
        # Rewrite everything else to index.html
        RewriteRule . /index.html [L]
    </Directory>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/startup-health-check-error.log
    CustomLog ${APACHE_LOG_DIR}/startup-health-check-access.log combined

Include /etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /etc/letsencrypt/live/devin05.deploymirror.com/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/devin05.deploymirror.com/privkey.pem
</VirtualHost>
</IfModule>
